<?php
$SOCKET = '/var/run/p0f.sock';
$QUERY_IP = array_key_exists('ip', $_REQUEST) ? $_REQUEST['ip'] : $_SERVER['REMOTE_ADDR'];
?>
<html>
<body>
    <form method="GET">
        IP: <input name="ip" value="<?=$QUERY_IP?>">
        <input type="submit">
    </form>
<?php
ini_set('display_errors', 1);
error_reporting(E_ALL);


define("P0F_STATUS_BADQUERY", 0x00);
define("P0F_STATUS_OK",       0x10);
define("P0F_STATUS_NOMATCH",  0x20);

//see http://www.iana.org/assignments/tls-extensiontype-values/tls-extensiontype-values.xml
$tlsExtensions = array(
    0   => "server_name",
    1   => "max_fragment_length",
    2   => "client_certificate_url",
    3   => "trusted_ca_keys",
    4   => "truncated_hmac",
    5   => "status_request",
    6   => "user_mapping",
    7   => "client_authz",
    8   => "server_authz",
    9   => "cert_type",
    10  => "elliptic_curves",
    11  => "ec_point_formats",
    12  => "srp",
    13  => "signature_algorithms",
    14  => "use_srtp",
    15  => "heartbeat",
    16  => "application_layer_protocol_negotiation",
    17  => "status_request_v2",
    18  => "signed_certificate_timestamp",
    19  => "client_certificate_type",
    20  => "server_certificate_type",
    21  => "padding", # temporary till 2015-03-12
    22  => "encrypt_then_mac", # temporary till 2015-06-05
    35  => "SessionTicket TLS",
    40  => "extended_random",
    13172 => "next_protocol_negotiation",
    13175 => "origin_bound_certificates",
    13180 => "encrypted_client_certificates",
    30031 => "channel_id",
    30032 => "channel_id_new",
    35655 => "padding",
    65281 => "renegotiation_info"
);

// Known SSL and TLS suites
$suitesData = <<< END_OF_DATA
SSL_CK_RC4_128_WITH_MD5,0x010080,128,SSL_2_0
SSL_CK_RC4_128_EXPORT40_WITH_MD5,0x020080,40,SSL_2_0
SSL_CK_RC2_128_CBC_WITH_MD5,0x030080,128,SSL_2_0
SSL_CK_RC2_128_CBC_EXPORT40_WITH_MD5,0x040080,40,SSL_2_0
SSL_CK_IDEA_128_CBC_WITH_MD5,0x050080,128,SSL_2_0
SSL_CK_DES_64_CBC_WITH_MD5,0x060040,56,SSL_2_0
SSL_CK_DES_192_EDE3_CBC_WITH_MD5,0x0700c0,168,SSL_2_0
SSL_CK_RC4_64_WITH_MD5,0x080080,64,SSL_2_0
SSL_RC4_128_WITH_MD5,0x010080,128,SSL_3_0
SSL_RC4_128_EXPORT40_WITH_MD5,0x020080,40,SSL_3_0
SSL_RC2_128_CBC_WITH_MD5,0x030080,128,SSL_3_0
SSL_RC2_128_CBC_EXPORT40_WITH_MD5,0x040080,40,SSL_3_0
SSL_IDEA_128_CBC_WITH_MD5,0x050080,128,SSL_3_0
SSL_DES_64_CBC_WITH_MD5,0x060040,56,SSL_3_0
SSL_DES_192_EDE3_CBC_WITH_MD5,0x0700c0,168,SSL_3_0
# Duplicates
#SSL_NULL_WITH_NULL_NULL,0x00,0,SSL_3_0
#SSL_RSA_WITH_NULL_MD5,0x01,0,SSL_3_0
#SSL_RSA_WITH_NULL_SHA,0x02,0,SSL_3_0
#SSL_RSA_EXPORT_WITH_RC4_40_MD5,0x03,40,SSL_3_0
#SSL_RSA_WITH_RC4_128_MD5,0x04,128,SSL_3_0
#SSL_RSA_WITH_RC4_128_SHA,0x05,128,SSL_3_0
#SSL_RSA_EXPORT_WITH_RC2_CBC_40_MD5,0x06,40,SSL_3_0
#SSL_RSA_WITH_IDEA_CBC_SHA,0x07,128,SSL_3_0
#SSL_RSA_EXPORT_WITH_DES40_CBC_SHA,0x08,40,SSL_3_0
#SSL_RSA_WITH_DES_CBC_SHA,0x09,56,SSL_3_0
#SSL_RSA_WITH_3DES_EDE_CBC_SHA,0x0a,168,SSL_3_0
#SSL_DH_DSS_EXPORT_WITH_DES40_CBC_SHA,0x0b,40,SSL_3_0
#SSL_DH_DSS_WITH_DES_CBC_SHA,0x0c,56,SSL_3_0
#SSL_DH_DSS_WITH_3DES_EDE_CBC_SHA,0x0d,168,SSL_3_0
#SSL_DH_RSA_EXPORT_WITH_DES40_CBC_SHA,0x0e,40,SSL_3_0
#SSL_DH_RSA_WITH_DES_CBC_SHA,0x0f,56,SSL_3_0
#SSL_DH_RSA_WITH_3DES_EDE_CBC_SHA,0x10,168,SSL_3_0
#SSL_DHE_DSS_EXPORT_WITH_DES40_CBC_SHA,0x11,40,SSL_3_0
#SSL_DHE_DSS_WITH_DES_CBC_SHA,0x12,56,SSL_3_0
#SSL_DHE_DSS_WITH_3DES_EDE_CBC_SHA,0x13,168,SSL_3_0
#SSL_DHE_RSA_EXPORT_WITH_DES40_CBC_SHA,0x14,40,SSL_3_0
#SSL_DHE_RSA_WITH_DES_CBC_SHA,0x15,56,SSL_3_0
#SSL_DHE_RSA_WITH_3DES_EDE_CBC_SHA,0x16,168,SSL_3_0
#SSL_DH_anon_EXPORT_WITH_RC4_40_MD5,0x17,40,SSL_3_0
#SSL_DH_anon_WITH_RC4_128_MD5,0x18,128,SSL_3_0
#SSL_DH_anon_EXPORT_WITH_DES40_CBC_SHA,0x19,40,SSL_3_0
#SSL_DH_anon_WITH_DES_CBC_SHA,0x1a,56,SSL_3_0
SSL_DH_anon_WITH_3DES_EDE_CBC_SHA,0x1b,168,SSL_3_0
SSL_FORTEZZA_KEA_WITH_NULL_SHA,0x1c,0,SSL_3_0
SSL_FORTEZZA_KEA_WITH_FORTEZZA_CBC_SHA,0x1d,96,SSL_3_0
SSL_FORTEZZA_KEA_WITH_RC4_128_SHA,0x1e,128,SSL_3_0
# Duplicates
#TLS_RC4_128_WITH_MD5,0x010080,128,TLS_1_0
#TLS_RC4_128_EXPORT40_WITH_MD5,0x020080,40,TLS_1_0
#TLS_RC2_128_CBC_WITH_MD5,0x030080,128,TLS_1_0
#TLS_RC2_128_CBC_EXPORT40_WITH_MD5,0x040080,40,TLS_1_0
#TLS_IDEA_128_CBC_WITH_MD5,0x050080,128,TLS_1_0
#TLS_DES_64_CBC_WITH_MD5,0x060040,56,TLS_1_0
#TLS_DES_192_EDE3_CBC_WITH_MD5,0x0700c0,168,TLS_1_0
TLS_NULL_WITH_NULL_NULL,0x00,0,TLS_1_0
TLS_RSA_WITH_NULL_MD5,0x01,0,TLS_1_0
TLS_RSA_WITH_NULL_SHA,0x02,0,TLS_1_0
TLS_RSA_EXPORT_WITH_RC4_40_MD5,0x03,40,TLS_1_0
TLS_RSA_WITH_RC4_128_MD5,0x04,128,TLS_1_0
TLS_RSA_WITH_RC4_128_SHA,0x05,128,TLS_1_0
TLS_RSA_EXPORT_WITH_RC2_CBC_40_MD5,0x06,40,TLS_1_0
TLS_RSA_WITH_IDEA_CBC_SHA,0x07,128,TLS_1_0
TLS_RSA_EXPORT_WITH_DES40_CBC_SHA,0x08,40,TLS_1_0
TLS_RSA_WITH_DES_CBC_SHA,0x09,56,TLS_1_0
TLS_RSA_WITH_3DES_EDE_CBC_SHA,0x0a,168,TLS_1_0
TLS_DH_DSS_EXPORT_WITH_DES40_CBC_SHA,0x0b,40,TLS_1_0
TLS_DH_DSS_WITH_DES_CBC_SHA,0x0c,56,TLS_1_0
TLS_DH_DSS_WITH_3DES_EDE_CBC_SHA,0x0d,168,TLS_1_0
TLS_DH_RSA_EXPORT_WITH_DES40_CBC_SHA,0x0e,40,TLS_1_0
TLS_DH_RSA_WITH_DES_CBC_SHA,0x0f,56,TLS_1_0
TLS_DH_RSA_WITH_3DES_EDE_CBC_SHA,0x10,168,TLS_1_0
TLS_DHE_DSS_EXPORT_WITH_DES40_CBC_SHA,0x11,40,TLS_1_0
TLS_DHE_DSS_WITH_DES_CBC_SHA,0x12,56,TLS_1_0
TLS_DHE_DSS_WITH_3DES_EDE_CBC_SHA,0x13,168,TLS_1_0
TLS_DHE_RSA_EXPORT_WITH_DES40_CBC_SHA,0x14,40,TLS_1_0
TLS_DHE_RSA_WITH_DES_CBC_SHA,0x15,56,TLS_1_0
TLS_DHE_RSA_WITH_3DES_EDE_CBC_SHA,0x16,168,TLS_1_0
TLS_DH_anon_EXPORT_WITH_RC4_40_MD5,0x17,40,TLS_1_0
TLS_DH_anon_WITH_RC4_128_MD5,0x18,128,TLS_1_0
TLS_DH_anon_EXPORT_WITH_DES40_CBC_SHA,0x19,40,TLS_1_0
TLS_DH_anon_WITH_DES_CBC_SHA,0x1a,56,TLS_1_0
TLS_DH_anon_WITH_3DES_EDE_CBC_SHA,0x1b,168,TLS_1_0
TLS_KRB5_WITH_DES_CBC_SHA,0x1e,56,TLSKRB
TLS_KRB5_WITH_3DES_EDE_CBC_SHA,0x1f,168,TLSKRB
TLS_KRB5_WITH_RC4_128_SHA,0x20,128,TLSKRB
TLS_KRB5_WITH_IDEA_CBC_SHA,0x21,128,TLSKRB
TLS_KRB5_WITH_DES_CBC_MD5,0x22,56,TLSKRB
TLS_KRB5_WITH_3DES_EDE_CBC_MD5,0x23,168,TLSKRB
TLS_KRB5_WITH_RC4_128_MD5,0x24,128,TLSKRB
TLS_KRB5_WITH_IDEA_CBC_MD5,0x25,128,TLSKRB
TLS_KRB5_EXPORT_WITH_DES_CBC_40_SHA,0x26,40,TLSKRB
TLS_KRB5_EXPORT_WITH_RC2_CBC_40_SHA,0x27,40,TLSKRB
TLS_KRB5_EXPORT_WITH_RC4_40_SHA,0x28,40,TLSKRB
TLS_KRB5_EXPORT_WITH_DES_CBC_40_MD5,0x29,40,TLSKRB
TLS_KRB5_EXPORT_WITH_RC2_CBC_40_MD5,0x2a,40,TLSKRB
TLS_KRB5_EXPORT_WITH_RC4_40_MD5,0x2b,40,TLSKRB
TLS_RSA_WITH_AES_128_CBC_SHA,0x2f,128,TLSAES
TLS_DH_DSS_WITH_AES_128_CBC_SHA,0x30,128,TLSAES
TLS_DH_RSA_WITH_AES_128_CBC_SHA,0x31,128,TLSAES
TLS_DHE_DSS_WITH_AES_128_CBC_SHA,0x32,128,TLSAES
TLS_DHE_RSA_WITH_AES_128_CBC_SHA,0x33,128,TLSAES
TLS_DH_anon_WITH_AES_128_CBC_SHA,0x34,128,TLSAES
TLS_RSA_WITH_AES_256_CBC_SHA,0x35,256,TLSAES
TLS_DH_DSS_WITH_AES_256_CBC_SHA,0x36,256,TLSAES
TLS_DH_RSA_WITH_AES_256_CBC_SHA,0x37,256,TLSAES
TLS_DHE_DSS_WITH_AES_256_CBC_SHA,0x38,256,TLSAES
TLS_DHE_RSA_WITH_AES_256_CBC_SHA,0x39,256,TLSAES
TLS_DH_anon_WITH_AES_256_CBC_SHA,0x3a,256,TLSAES
# Not official (never used?) and clash with some TLS 1.2 suites
#TLS_RSA_WITH_MISTY1_CBC_SHA,0x3b,128,TLSMISTY1
#TLS_DH_DSS_WITH_MISTY1_CBC_SHA,0x3c,128,TLSMISTY1
#TLS_DH_RSA_WITH_MISTY1_CBC_SHA,0x3d,128,TLSMISTY1
#TLS_DHE_DSS_WITH_MISTY1_CBC_SHA,0x3e,128,TLSMISTY1
#TLS_DHE_RSA_WITH_MISTY1_CBC_SHA,0x3f,128,TLSMISTY1
#TLS_DH_anon_WITH_MISTY1_CBC_SHA,0x40,128,TLSMISTY1
TLS_RSA_WITH_CAMELLIA_128_CBC_SHA,0x41,128,TLSCAM
TLS_DH_DSS_WITH_CAMELLIA_128_CBC_SHA,0x42,128,TLSCAM
TLS_DH_RSA_WITH_CAMELLIA_128_CBC_SHA,0x43,128,TLSCAM
TLS_DHE_DSS_WITH_CAMELLIA_128_CBC_SHA,0x44,128,TLSCAM
TLS_DHE_RSA_WITH_CAMELLIA_128_CBC_SHA,0x45,128,TLSCAM
TLS_DH_anon_WITH_CAMELLIA_128_CBC_SHA,0x46,128,TLSCAM
TLS_RSA_WITH_CAMELLIA_256_CBC_SHA,0x84,256,TLSCAM
TLS_DH_DSS_WITH_CAMELLIA_256_CBC_SHA,0x85,256,TLSCAM
TLS_DH_RSA_WITH_CAMELLIA_256_CBC_SHA,0x86,256,TLSCAM
TLS_DHE_DSS_WITH_CAMELLIA_256_CBC_SHA,0x87,256,TLSCAM
TLS_DHE_RSA_WITH_CAMELLIA_256_CBC_SHA,0x88,256,TLSCAM
TLS_DH_anon_WITH_CAMELLIA_256_CBC_SHA,0x89,256,TLSCAM
TLS_PSK_WITH_RC4_128_SHA,0x8a,128,TLSPSK
TLS_PSK_WITH_3DES_EDE_CBC_SHA,0x8b,168,TLSPSK
TLS_PSK_WITH_AES_128_CBC_SHA,0x8c,128,TLSPSK
TLS_PSK_WITH_AES_256_CBC_SHA,0x8d,256,TLSPSK
TLS_DHE_PSK_WITH_RC4_128_SHA,0x8e,128,TLSPSK
TLS_DHE_PSK_WITH_3DES_EDE_CBC_SHA,0x8f,168,TLSPSK
TLS_DHE_PSK_WITH_AES_128_CBC_SHA,0x90,128,TLSPSK
TLS_DHE_PSK_WITH_AES_256_CBC_SHA,0x91,256,TLSPSK
TLS_RSA_PSK_WITH_RC4_128_SHA,0x92,128,TLSPSK
TLS_RSA_PSK_WITH_3DES_EDE_CBC_SHA,0x93,168,TLSPSK
TLS_RSA_PSK_WITH_AES_128_CBC_SHA,0x94,128,TLSPSK
TLS_RSA_PSK_WITH_AES_256_CBC_SHA,0x95,256,TLSPSK
TLS_RSA_WITH_SEED_CBC_SHA,0x96,128,SEED
TLS_DH_DSS_WITH_SEED_CBC_SHA,0x97,128,SEED
TLS_DH_RSA_WITH_SEED_CBC_SHA,0x98,128,SEED
TLS_DHE_DSS_WITH_SEED_CBC_SHA,0x99,128,SEED
TLS_DHE_RSA_WITH_SEED_CBC_SHA,0x9a,128,SEED
TLS_DH_anon_WITH_SEED_CBC_SHA,0x9b,128,SEED
TLS_NULL_WITH_NULL_NULL,0x00,0,TLS_1_1
TLS_RSA_WITH_NULL_MD5,0x01,0,TLS_1_1
TLS_RSA_WITH_NULL_SHA,0x02,0,TLS_1_1
TLS_RSA_WITH_RC4_128_MD5,0x04,128,TLS_1_1
TLS_RSA_WITH_RC4_128_SHA,0x05,128,TLS_1_1
TLS_RSA_WITH_IDEA_CBC_SHA,0x07,128,TLS_1_1
TLS_RSA_WITH_DES_CBC_SHA,0x09,56,TLS_1_1
TLS_RSA_WITH_3DES_EDE_CBC_SHA,0x0a,168,TLS_1_1
TLS_DH_DSS_WITH_DES_CBC_SHA,0x0c,56,TLS_1_1
TLS_DH_DSS_WITH_3DES_EDE_CBC_SHA,0x0d,168,TLS_1_1
TLS_DH_RSA_WITH_DES_CBC_SHA,0x0f,56,TLS_1_1
TLS_DH_RSA_WITH_3DES_EDE_CBC_SHA,0x10,168,TLS_1_1
TLS_DHE_DSS_WITH_DES_CBC_SHA,0x12,56,TLS_1_1
TLS_DHE_DSS_WITH_3DES_EDE_CBC_SHA,0x13,168,TLS_1_1
TLS_DHE_RSA_WITH_DES_CBC_SHA,0x15,56,TLS_1_1
TLS_DHE_RSA_WITH_3DES_EDE_CBC_SHA,0x16,168,TLS_1_1
TLS_DH_anon_WITH_RC4_128_MD5,0x18,128,TLS_1_1
TLS_DH_anon_WITH_DES_CBC_SHA,0x1a,56,TLS_1_1
TLS_DH_anon_WITH_3DES_EDE_CBC_SHA,0x1b,168,TLS_1_1
TLS_KRB5_WITH_DES_CBC_SHA,0x1e,56,TLS_1_1
TLS_KRB5_WITH_3DES_EDE_CBC_SHA,0x1f,168,TLS_1_1
TLS_KRB5_WITH_RC4_128_SHA,0x20,128,TLS_1_1
TLS_KRB5_WITH_IDEA_CBC_SHA,0x21,128,TLS_1_1
TLS_KRB5_WITH_DES_CBC_MD5,0x22,56,TLS_1_1
TLS_KRB5_WITH_3DES_EDE_CBC_MD5,0x23,168,TLS_1_1
TLS_KRB5_WITH_RC4_128_MD5,0x24,128,TLS_1_1
TLS_KRB5_WITH_IDEA_CBC_MD5,0x25,128,TLS_1_1
TLS_RSA_WITH_AES_128_CBC_SHA,0x2f,128,TLS_1_1
TLS_DH_DSS_WITH_AES_128_CBC_SHA,0x30,128,TLS_1_1
TLS_DH_RSA_WITH_AES_128_CBC_SHA,0x31,128,TLS_1_1
TLS_DHE_DSS_WITH_AES_128_CBC_SHA,0x32,128,TLS_1_1
TLS_DHE_RSA_WITH_AES_128_CBC_SHA,0x33,128,TLS_1_1
TLS_DH_anon_WITH_AES_128_CBC_SHA,0x34,128,TLS_1_1
TLS_RSA_WITH_AES_256_CBC_SHA,0x35,256,TLS_1_1
TLS_DH_DSS_WITH_AES_256_CBC_SHA,0x36,256,TLS_1_1
TLS_DH_RSA_WITH_AES_256_CBC_SHA,0x37,256,TLS_1_1
TLS_DHE_DSS_WITH_AES_256_CBC_SHA,0x38,256,TLS_1_1
TLS_DHE_RSA_WITH_AES_256_CBC_SHA,0x39,256,TLS_1_1
TLS_DH_anon_WITH_AES_256_CBC_SHA,0x3a,256,TLS_1_1
TLS_ECDH_ECDSA_WITH_NULL_SHA,0xc001,0,TLSECC
TLS_ECDH_ECDSA_WITH_RC4_128_SHA,0xc002,128,TLSECC
TLS_ECDH_ECDSA_WITH_3DES_EDE_CBC_SHA,0xc003,168,TLSECC
TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA,0xc004,128,TLSECC
TLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA,0xc005,256,TLSECC
TLS_ECDHE_ECDSA_WITH_NULL_SHA,0xc006,0,TLSECC
TLS_ECDHE_ECDSA_WITH_RC4_128_SHA,0xc007,128,TLSECC
TLS_ECDHE_ECDSA_WITH_3DES_EDE_CBC_SHA,0xc008,168,TLSECC
TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA,0xc009,128,TLSECC
TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA,0xc00a,256,TLSECC
TLS_ECDH_RSA_WITH_NULL_SHA,0xc00b,0,TLSECC
TLS_ECDH_RSA_WITH_RC4_128_SHA,0xc00c,128,TLSECC
TLS_ECDH_RSA_WITH_3DES_EDE_CBC_SHA,0xc00d,168,TLSECC
TLS_ECDH_RSA_WITH_AES_128_CBC_SHA,0xc00e,128,TLSECC
TLS_ECDH_RSA_WITH_AES_256_CBC_SHA,0xc00f,256,TLSECC
TLS_ECDHE_RSA_WITH_NULL_SHA,0xc010,0,TLSECC
TLS_ECDHE_RSA_WITH_RC4_128_SHA,0xc011,128,TLSECC
TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA,0xc012,168,TLSECC
TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA,0xc013,128,TLSECC
TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA,0xc014,256,TLSECC
TLS_ECDH_anon_WITH_NULL_SHA,0xc015,0,TLSECC
TLS_ECDH_anon_WITH_RC4_128_SHA,0xc016,128,TLSECC
TLS_ECDH_anon_WITH_3DES_EDE_CBC_SHA,0xc017,168,TLSECC
TLS_ECDH_anon_WITH_AES_128_CBC_SHA,0xc018,128,TLSECC
TLS_ECDH_anon_WITH_AES_256_CBC_SHA,0xc019,256,TLSECC
TLS_SRP_SHA_WITH_3DES_EDE_CBC_SHA,0xc01a,168,TLSSRP
TLS_SRP_SHA_RSA_WITH_3DES_EDE_CBC_SHA,0xc01b,168,TLSSRP
TLS_SRP_SHA_DSS_WITH_3DES_EDE_CBC_SHA,0xc01c,168,TLSSRP
TLS_SRP_SHA_WITH_AES_128_CBC_SHA,0xc01d,128,TLSSRP
TLS_SRP_SHA_RSA_WITH_AES_128_CBC_SHA,0xc01e,128,TLSSRP
TLS_SRP_SHA_DSS_WITH_AES_128_CBC_SHA,0xc01f,128,TLSSRP
TLS_SRP_SHA_WITH_AES_256_CBC_SHA,0xc020,256,TLSSRP
TLS_SRP_SHA_RSA_WITH_AES_256_CBC_SHA,0xc021,256,TLSSRP
TLS_SRP_SHA_DSS_WITH_AES_256_CBC_SHA,0xc022,256,TLSSRP
TLS_PSK_WITH_NULL_SHA,0x2c,0,TLSPSK-NULL
TLS_DHE_PSK_WITH_NULL_SHA,0x2d,0,TLSPSK-NULL
TLS_RSA_PSK_WITH_NULL_SHA,0x2e,0,TLSPSK-NULL
TLS_NULL_WITH_NULL_NULL,0x00,0,TLS_1_2
TLS_RSA_WITH_NULL_MD5,0x01,0,TLS_1_2
TLS_RSA_WITH_NULL_SHA,0x02,0,TLS_1_2
TLS_RSA_WITH_RC4_128_MD5,0x04,128,TLS_1_2
TLS_RSA_WITH_RC4_128_SHA,0x05,128,TLS_1_2
TLS_RSA_WITH_3DES_EDE_CBC_SHA,0x0a,168,TLS_1_2
TLS_RSA_WITH_AES_128_CBC_SHA,0x2f,128,TLS_1_2
TLS_RSA_WITH_AES_256_CBC_SHA,0x35,256,TLS_1_2
TLS_RSA_WITH_NULL_SHA256,0x3b,0,TLS_1_2
TLS_RSA_WITH_AES_128_CBC_SHA256,0x3c,128,TLS_1_2
TLS_RSA_WITH_AES_256_CBC_SHA256,0x3d,256,TLS_1_2
TLS_DH_DSS_WITH_3DES_EDE_CBC_SHA,0x0d,168,TLS_1_2
TLS_DH_RSA_WITH_3DES_EDE_CBC_SHA,0x10,168,TLS_1_2
TLS_DHE_DSS_WITH_3DES_EDE_CBC_SHA,0x13,168,TLS_1_2
TLS_DHE_RSA_WITH_3DES_EDE_CBC_SHA,0x16,168,TLS_1_2
TLS_DH_DSS_WITH_AES_128_CBC_SHA,0x30,128,TLS_1_2
TLS_DH_RSA_WITH_AES_128_CBC_SHA,0x31,128,TLS_1_2
TLS_DHE_DSS_WITH_AES_128_CBC_SHA,0x32,128,TLS_1_2
TLS_DHE_RSA_WITH_AES_128_CBC_SHA,0x33,128,TLS_1_2
TLS_DH_DSS_WITH_AES_256_CBC_SHA,0x36,256,TLS_1_2
TLS_DH_RSA_WITH_AES_256_CBC_SHA,0x37,256,TLS_1_2
TLS_DHE_DSS_WITH_AES_256_CBC_SHA,0x38,256,TLS_1_2
TLS_DHE_RSA_WITH_AES_256_CBC_SHA,0x39,256,TLS_1_2
TLS_DH_DSS_WITH_AES_128_CBC_SHA256,0x3e,128,TLS_1_2
TLS_DH_RSA_WITH_AES_128_CBC_SHA256,0x3f,128,TLS_1_2
TLS_DHE_DSS_WITH_AES_128_CBC_SHA256,0x40,128,TLS_1_2
TLS_RSA_EXPORT1024_WITH_RC4_56_MD5,0x60,56,56BIT
TLS_RSA_EXPORT1024_WITH_RC2_CBC_56_MD5,0x61,56,56BIT
TLS_RSA_EXPORT1024_WITH_DES_CBC_SHA,0x62,56,56BIT
TLS_DHE_DSS_EXPORT1024_WITH_DES_CBC_SHA,0x63,56,56BIT
TLS_RSA_EXPORT1024_WITH_RC4_56_SHA,0x64,56,56BIT
TLS_DHE_DSS_EXPORT1024_WITH_RC4_56_SHA,0x65,56,56BIT
TLS_DHE_DSS_WITH_RC4_128_SHA,0x66,128,56BIT
TLS_DHE_RSA_WITH_AES_128_CBC_SHA256,0x67,128,TLS_1_2
TLS_DH_DSS_WITH_AES_256_CBC_SHA256,0x68,256,TLS_1_2
TLS_DH_RSA_WITH_AES_256_CBC_SHA256,0x69,256,TLS_1_2
TLS_DHE_DSS_WITH_AES_256_CBC_SHA256,0x6a,256,TLS_1_2
TLS_DHE_RSA_WITH_AES_256_CBC_SHA256,0x6b,256,TLS_1_2
TLS_DH_anon_WITH_RC4_128_MD5,0x18,128,TLS_1_2
TLS_DH_anon_WITH_3DES_EDE_CBC_SHA,0x1b,168,TLS_1_2
TLS_DH_anon_WITH_AES_128_CBC_SHA,0x34,128,TLS_1_2
TLS_DH_anon_WITH_AES_256_CBC_SHA,0x3a,256,TLS_1_2
TLS_DH_anon_WITH_AES_128_CBC_SHA256,0x6c,128,TLS_1_2
TLS_DH_anon_WITH_AES_256_CBC_SHA256,0x6d,256,TLS_1_2
TLS_RSA_WITH_AES_128_GCM_SHA256,0x9c,128,TLSAES-GCM
TLS_RSA_WITH_AES_256_GCM_SHA384,0x9d,256,TLSAES-GCM
TLS_DHE_RSA_WITH_AES_128_GCM_SHA256,0x9e,128,TLSAES-GCM
TLS_DHE_RSA_WITH_AES_256_GCM_SHA384,0x9f,256,TLSAES-GCM
TLS_DH_RSA_WITH_AES_128_GCM_SHA256,0xa0,128,TLSAES-GCM
TLS_DH_RSA_WITH_AES_256_GCM_SHA384,0xa1,256,TLSAES-GCM
TLS_DHE_DSS_WITH_AES_128_GCM_SHA256,0xa2,128,TLSAES-GCM
TLS_DHE_DSS_WITH_AES_256_GCM_SHA384,0xa3,256,TLSAES-GCM
TLS_DH_DSS_WITH_AES_128_GCM_SHA256,0xa4,128,TLSAES-GCM
TLS_DH_DSS_WITH_AES_256_GCM_SHA384,0xa5,256,TLSAES-GCM
TLS_DH_anon_WITH_AES_128_GCM_SHA256,0xa6,128,TLSAES-GCM
TLS_DH_anon_WITH_AES_256_GCM_SHA384,0xa7,256,TLSAES-GCM
TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256,0xc023,128,TLSECC-GCM
TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384,0xc024,256,TLSECC-GCM
TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA256,0xc025,128,TLSECC-GCM
TLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA384,0xc026,256,TLSECC-GCM
TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256,0xc027,128,TLSECC-GCM
TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384,0xc028,256,TLSECC-GCM
TLS_ECDH_RSA_WITH_AES_128_CBC_SHA256,0xc029,128,TLSECC-GCM
TLS_ECDH_RSA_WITH_AES_256_CBC_SHA384,0xc02a,256,TLSECC-GCM
TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,0xc02b,128,TLSECC-GCM
TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,0xc02c,256,TLSECC-GCM
TLS_ECDH_ECDSA_WITH_AES_128_GCM_SHA256,0xc02d,128,TLSECC-GCM
TLS_ECDH_ECDSA_WITH_AES_256_GCM_SHA384,0xc02e,256,TLSECC-GCM
TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,0xc02f,128,TLSECC-GCM
TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,0xc030,256,TLSECC-GCM
TLS_ECDH_RSA_WITH_AES_128_GCM_SHA256,0xc031,128,TLSECC-GCM
TLS_ECDH_RSA_WITH_AES_256_GCM_SHA384,0xc032,256,TLSECC-GCM
SSL_RSA_FIPS_WITH_3DES_EDE_CBC_SHA,0xffe0,168,NSS
SSL_RSA_FIPS_WITH_DES_CBC_SHA,0xffe1,56,NSS
SSL_RSA_FIPS_WITH_DES_CBC_SHA,0xfefe,56,NSS
SSL_RSA_FIPS_WITH_3DES_EDE_CBC_SHA,0xfeff,168,NSS
TLS_EMPTY_RENEGOTIATION_INFO_SCSV,0xff,0,RI
TLS_FALLBACK_SCSV,0x5600,0,RI
END_OF_DATA;
// Convert suite data into a hashmap
$cipherDatabase = array();
$suiteLines = preg_split("/\n/", $suitesData);
foreach($suiteLines as $suiteLine) {
    $suiteLine = trim($suiteLine);

    // Do not process comment lines.
    if ($suiteLine[0] == '#') {
        continue;
    }
    $suite = preg_split("/,/", $suiteLine);
    if (preg_match("/^0x0*+(.+)$/", $suite[1], $m)) {
        $cipherDatabase[$m[1]] = $suite[0];
    }
}

ob_end_flush();
ob_implicit_flush(true);

$fd = fsockopen("unix://" . $SOCKET);

/*
 * Queries have exactly 21 bytes. The format is:
 *
 * - Magic dword (0x50304601), in native endian of the platform.
 *
 * - Address type byte: 4 for IPv4, 6 for IPv6.
 *
 * - 16 bytes of address data, network endian. IPv4 addresses should be
 *  aligned to the left. (big endian left align)
 *
 */
$query = pack("LCNNNN",
    0x50304601,
    4, /* IPv4 */
    ip2long($QUERY_IP),
    0,
    0,
    0
);

fwrite($fd, $query);
$r =  fgets($fd, 442);
fclose($fd);

$resp = unpack(
    "Lmagic/"  .          // Must be P0F_RESP_MAGIC
    "Lstatus/" .          // P0F_STATUS_*
    "Lfirst_seen/" .      // First seen (unix time)
    "Llast_seen/" .       // Last seen (unix time)
    "Ltotal_conn/".       // Total connections seen
    "Luptime_min/" .      // Last uptime (minutes)
    "Lup_mod_days/" .     // Uptime modulo (days)
    "Llast_nat/" .        // NAT / LB last detected (unix time)
    "Llast_chg/" .        // OS chg last detected (unix time)
    "Sdistance/" .        // System distance
    "Cbad_sw/" .          // Host is lying about U-A / Server
    "Cos_match_q/" .      // Match quality
    "a32os_name/" .       // Name of detected OS
    "a32os_flavor/" .     // Flavor of detected OS
    "a32http_name/" .     // Name of detected HTTP app
    "a32http_flavor/" .   // Flavor of detected HTTP app
    "a32link_type/" .     // Link type
    "a32language/" .      // Language
    "Lssl_remote_time/" . // Last client timestamp from SSL
    "Lssl_recv_time/" .    // Language
    "a201ssl_raw_sig",    // ssl client handshake raw signature
    $r
);

foreach(array('os_name', 'os_flavor', 'http_name', 'http_flavor', 'link_type', 'language', 'ssl_raw_sig') as $field) {
    $resp[$field] = trim($resp[$field]);
}

if($resp["status"] == P0F_STATUS_BADQUERY) {
    echo "bad query";
    exit;
} elseif ($resp["status"] == P0F_STATUS_NOMATCH) {
    echo "no match";
    exit;
}
?>
<h2>Fingerprint Match</h2>
<table border="1">
<?php foreach ($resp as $key => $value) {
?>
    <tr><td><?=$key?></td><td><?=$value?></td></tr>

<?php
}
?>
</table>
<?php
if (trim($resp["ssl_raw_sig"]) != "") {
    list($sslver, $ciphers, $extensions, $sslflags) = explode(":", $resp['ssl_raw_sig']);

    $ciphers = implode("<br/>",array_map(function($cipher) use ($cipherDatabase) {
        return array_key_exists($cipher, $cipherDatabase) ? $cipherDatabase[$cipher] : $cipher;
    }, explode(",", $ciphers)));

    $extensions = implode("<br/>",array_map(function($extension) use ($tlsExtensions) {
        $extension = hexdec($extension);
        return array_key_exists($extension, $tlsExtensions) ? $tlsExtensions[$extension] : $extension;
    }, explode(",", $extensions)));

    ?>
<h2>SSL Info</h2>
<table border=1>
    <tr><td>Version</td><td><?=$sslver?></td></tr>
    <tr><td>Ciphers</td><td><?=$ciphers?></td></tr>
    <tr><td>Extensions</td><td><?=$extensions?></td></tr>
    <tr><td>Flags</td><td><?=$sslflags?></td></tr>
</table>

<?php
}

?>